/*
  @library      jQuery Tokenizing Autocomplete Plugin
  @version      1.2
  @author       James Smith
  @copyright    Copyright (c) 2010
  @website      https://github.com/loopj/jQuery-Tokenizing-Autocomplete-Plugin
  
  This plugin was modified (forked) for use with the Drupal module, Navigate.
    
  Licensed jointly under the GPL and MIT licenses
*/
(function(c){c.fn.tokenInput=function(b,e){var f=c.extend({categories:false,contentType:"json",delimiter:',',descriptions:false,dropdownAnimation:'slideDown',dropdownDuration:'fast',dropdownLimit:10,duplicates:false,existingParam:"e",hintText:"Type in a search term",jsonContainer:null,noResultsText:"No results",method:"GET",minChars:1,onResult:null,prePopulate:null,queryParam:"q",searchingText:"Searching...",searchDelay:300,tokenLimit:null,url:b},e);f.classes=c.extend({fieldset:"token-input",tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownCategory:"token-input-dropdown-category",dropdownItem:"token-input-dropdown-item",dropdownItemZebra:"token-input-dropdown-item odd",dropdownItemDescription:"token-input-dropdown-item-description",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},e.classes);return this.each(function(){var a=new c.TokenList(this,f)})};c.TokenList=function(S,d){var q={BEFORE:0,AFTER:1,END:2};var j={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188};var bb=[];var z=0;var A=new c.TokenList.Cache();var H;var l=c("<input type=\"text\">").css({outline:"none"}).focus(function(){if(d.tokenLimit==null||d.tokenLimit!=z){T()}}).blur(function(){r()}).keydown(function(a){var b;var e;switch(a.keyCode){case j.LEFT:case j.RIGHT:case j.UP:case j.DOWN:if(!c(this).val()){b=o.prev();e=o.next();if((b.length&&b.get(0)===h)||(e.length&&e.get(0)===h)){if(a.keyCode==j.LEFT||a.keyCode==j.UP){v(c(h),q.BEFORE)}else{v(c(h),q.AFTER)}}else if((a.keyCode==j.LEFT||a.keyCode==j.UP)&&b.length){B(c(b.get(0)))}else if((a.keyCode==j.RIGHT||a.keyCode==j.DOWN)&&e.length){B(c(e.get(0)))}}else{var f=null;if(a.keyCode==j.DOWN||a.keyCode==j.RIGHT){f=c(m).next();if(!f.length){f=c(m).parent().nextAll('ul').find('li:first')}}else{f=c(m).prev();if(!f.length){f=c(m).parent().prevAll('ul').find('li:last')}}if(f.length){E(f)}return false}break;case j.BACKSPACE:b=o.prev();if(!c(this).val().length){if(h){F(c(h))}else if(b.length){B(c(b.get(0)))}return false}else if(c(this).val().length==1){r()}else{setTimeout(function(){I(false)},5)}break;case j.TAB:case j.RETURN:case j.COMMA:if(m){J(c(m))}return false;break;case j.ESC:r();return true;break;default:if(U(a.keyCode)){setTimeout(function(){I(false)},5)}break}});var s=c(S).hide().focus(function(){l.focus()}).blur(function(){l.blur()});var h=null;var m=null;var w=c("<fieldset />").addClass(d.classes.fieldset).insertAfter(s);var G=c("<ul />").addClass(d.classes.tokenList).appendTo(w).click(function(a){var b=x(a,"li");if(b&&b.get(0)!=o.get(0)){V(b);return false}else{l.focus();if(h){v(c(h),q.END)}}}).mouseover(function(a){var b=x(a,"li");if(b&&h!==this){b.addClass(d.classes.highlightedToken)}}).mouseout(function(a){var b=x(a,"li");if(b&&h!==this){b.removeClass(d.classes.highlightedToken)}}).mousedown(function(a){var b=x(a,"li");if(b){return false}});var p=c("<div>").addClass(d.classes.dropdown).insertAfter(G).hide();var o=c("<li />").addClass(d.classes.inputToken).appendTo(G).append(l);W();function W(){if(c.isFunction(d.prePopulate)){li_data=d.prePopulate.call(this)}else{li_data=d.prePopulate}var a=[];if(li_data&&li_data.length){for(var b in li_data){var e=c("<li><p>"+li_data[b].name+"</p> </li>").addClass(d.classes.token).insertBefore(o);c("<span>x</span>").addClass(d.classes.tokenDelete).appendTo(e).click(function(){F(c(this).parent());return false});c.data(e.get(0),"tokeninput",{"id":li_data[b].id,"name":li_data[b].name});l.val("").focus();r();a.push(li_data[b].id)}}s.val(a.join())}function K(a){var b=new RegExp(a);var e=s.val().match(b);return e==null?false:true}function U(a){if((a>=48&&a<=90)||(a>=96&&a<=111)||(a>=186&&a<=192)||(a>=219&&a<=222)){return true}else{return false}}function x(a,b){var e=c(a.target);var f=null;if(e.is(b)){f=e}else if(e.parent(b).length){f=e.parent(b+":first")}return f}function X(a,b){var e=c("<li><p>"+b+"</p> </li>").addClass(d.classes.token).insertBefore(o);c("<span>x</span>").addClass(d.classes.tokenDelete).appendTo(e).click(function(){F(c(this).parent());return false});c.data(e.get(0),"tokeninput",{"id":a,"name":b});return e}function J(a){if(w.hasClass('error')){w.removeClass('error')}var b=c.data(a.get(0),"tokeninput");var e=X(b.id,b.name);l.val("").focus();r();var f=s.val();var g=f==''?[]:f.split(',');g.push(b.id);s.val(g.join());z++;if(d.tokenLimit!=null&&d.tokenLimit>=z){l.hide();r()}A.flush()}function B(a){a.addClass(d.classes.selectedToken);h=a.get(0);l.val("");r()}function v(a,b){a.removeClass(d.classes.selectedToken);h=null;if(b==q.BEFORE){o.insertBefore(a)}else if(b==q.AFTER){o.insertAfter(a)}else{o.appendTo(G)}l.focus()}function V(a){if(h==a.get(0)){v(a,q.END)}else{if(h){v(c(h),q.END)}B(a)}}function F(a){var b=c.data(a.get(0),"tokeninput");a.remove();h=null;l.focus();var e=s.val();var f=e==''?[]:e.split(',');for(var g=0;g<f.length;g++){if(f[g]==b.id){f.splice(g,1)}}s.val(f.join());z--;A.flush();if(d.tokenLimit!=null){l.show().val("").focus()}}function r(){p.hide().empty();m=null;w.removeClass(d.classes.dropdown)}function Y(){w.addClass(d.classes.dropdown);p.html("<p>"+d.searchingText+"</p>").show()}function T(){w.addClass(d.classes.dropdown);p.html("<p>"+d.hintText+"</p>").show()}function L(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>");}function M(N,t){var k=[];for(var i=0;i<t.length;i++){t[i]=c.extend(true,{id:'',name:'',description:'',category:'',},t[i]);if(!K(t[i].id)){k.push(t[i]);}else if(K(t[i].id)&&d.duplicates){k.push(t[i]);}}if(k.length){p.hide().empty();var u={'none':{title:null,items:[]}};for(var i in k){if(d.categories){if(k[i].category==undefined||k[i].category==''){k[i].category='none';}if(u[k[i].category]==undefined){u[k[i].category]={title:k[i].category,items:[]};}}else{k[i].category='none';}u[k[i].category].items.push(k[i]);}function Z(e){var f={},g,n=[];for(g in e){if(e.hasOwnProperty(g)){n.push(e[g]);}}n.sort(function O(a,b){if(a.length<b.length)return-1;if(a.length>b.length)return 1;return 0;});for(g=0;g<n.length;g++){f[n[g].category]=n[g].length;}return f;}var C={};var D=0;c.each(u,function(a,b){var e=b.items.length;if(e){C[a]={'category':a,'length':e};D++;}});C=Z(C);var y,P=new Number(d.dropdownLimit);c.each(C,function(a,b){y=new Number(P);if(D>0){y=(y/D).toFixed();}if(b>=y){b=y;}u[a].limit=b;P-=b;D--;});c.each(u,function(g,n){if(g!='none'){c('<h3>').addClass(d.classes.dropdownCategory).html(g).appendTo(p);}var O=c("<ul>").appendTo(p).mouseover(function(a){E(x(a,"li"));}).click(function(a){J(x(a,"li"));}).mousedown(function(a){return false;});var Q=0;c.each(n.items,function(a,b){if(Q>=u[g].limit){return false;}Q++;var e=c("<li/>").html(L(b.name,N)).appendTo(O);var f=c("<span/>").addClass(d.classes.dropdownItemDescription).html(L(b.description,N)).appendTo(e);if(a%2){e.addClass(d.classes.dropdownItem);}else{e.addClass(d.classes.dropdownItemZebra);}c.data(e.get(0),"tokeninput",{"id":b.id,"name":b.name});});});E(c('li:first',p));p[d.dropdownAnimation](d.dropdownDuration);}else{p.html("<p>"+d.noResultsText+"</p>")[d.dropdownAnimation](d.dropdownDuration);}}function E(a){if(a){if(m){ba(c(m));}a.addClass(d.classes.selectedDropdownItem);m=a.get(0);}}function ba(a){a.removeClass(d.classes.selectedDropdownItem);m=null;}function I(a){var b=l.val().toLowerCase();if(b&&b.length){if(h){v(c(h),q.AFTER);}if(b.length>=d.minChars){var e=A.get(b);if(e){M(b,e);}else{Y();if(a){R(b);}else{clearTimeout(H);H=setTimeout(function(){R(b);},d.searchDelay);}}}else{r();}}}function R(b){var e=d.url.indexOf("?")<0?"?":"&";var f=function(a){if(c.isFunction(d.onResult)){a=d.onResult.call(this,a);}A.add(b,d.jsonContainer?a[d.jsonContainer]:a);M(b,d.jsonContainer?a[d.jsonContainer]:a);};var g={};g[d.queryParam]=b;g[d.existingParam]=s.val().replace(/,$/,'');if(d.method=="POST"){c.post(d.url,g,f,d.contentType)}else{c.get(d.url,g,f,d.contentType)}}};c.TokenList.Cache=function(e){var f=c.extend({max_size:50},e);var g={};var n=0;this.flush=function(){g={};n=0};this.add=function(a,b){if(n>f.max_size){flush()}if(!g[a]){n++}g[a]=b};this.get=function(a){return g[a]}}})(jQuery);
